function openIndicator(){$.showIndicator(),isIndicator=!0}function hideIndicator(){isIndicator&&($.hideIndicator(),isIndicator=!1),loading=!1}function loadDeduction(){var e=getLocalSession("channelType"),o=getLocalSession("custId")||"";if(2==userType&&3!=e){var s={interId:"toc.getIntegralCash",channel:"C",custId:o};xhq.__runXHQ(s,function(e){0==e.status?(deductionCash=e.body.deductionCash,0==deductionCash?$("#deductionCashCheckBox").attr("disabled","disabled"):(parseFloat(originalPrice)>=parseFloat(avoidExpressFee)?originalPrice>deductionCash?($("#deductionCashId").attr("deductionCash",deductionCash),$("#deductionCashId").text("¥"+deductionCash/100)):($("#deductionCashId").attr("deductionCash",originalPrice),$("#deductionCashId").text("¥"+originalPrice/100)):originalPrice+expressFee>deductionCash?($("#deductionCashId").attr("deductionCash",deductionCash),$("#deductionCashId").text("¥"+deductionCash/100)):($("#deductionCashId").attr("deductionCash",originalPrice),$("#deductionCashId").text("¥"+originalPrice/100)),$(".list3").show())):(deductionPrice=0,0==deductionCash&&$("#deductionCashCheckBox").attr("disabled","disabled"),$.toast(e.message))})}}function deductionCashChange(){1==$("#deductionCashCheckBox").attr("checked")&&($("#deductionCashCheckBox").val("1"),$("#realPay").text(function(){return parseFloat(originalPrice)>=parseFloat(avoidExpressFee)?originalPrice>deductionCash?((originalPrice-deductionCash)/100).toString():0:originalPrice+expressFee>deductionCash?((originalPrice+expressFee-deductionCash)/100).toString():0})),0==$("#deductionCashCheckBox").attr("checked")&&($("#deductionCashCheckBox").val("0"),$("#realPay").text(function(){return parseFloat(originalPrice)>=parseFloat(avoidExpressFee)?(originalPrice/100).toString():((originalPrice+expressFee)/100).toString()}))}function loadOrder(){var e=getLocalSession("channelType"),o=getLocalSession("localOrderSession");if(console.log("localOrderSession"+JSON.stringify(o)),null==o||""==o||void 0==o)return void(2==xhq.getQuery("fromUserType")?xhq.gotoUrl("home.html?version="+xhq.getVersion()):1==xhq.getQuery("isWs")?xhq.gotoUrl("ws_home.html?version="+xhq.getVersion()):xhq.gotoUrl("home.html?version="+xhq.getVersion()));var s=$("#mailList").html(),t=JSON.parse(o);if(t.length>0){for(var i=0;i<t.length;i++){var a=t[i];s+='<div class="list1"><hr>',s+='<div class="list1-img"><img src="'+a.bigPic+'" alt=""></div>',s+='<div class="list1-wenzi">',s+="<p>"+a.showName+"</p>",s+=3==e?'<span class="price" salePrice='+a.salePrice+"></span>":'<span class="bargain-price price" salePrice='+a.salePrice+">"+a.salePrice/100+"</span>",s+='<span class="youfei" style="display:none;" mailMoney='+a.mailMoney+">"+a.mailMoney+"</span><span num="+a.num+' class="img">'+a.num+"</span>",s+='<p class="norms1"></p>',s+="</div>",s+="</div>"}$("#mailList").html(s)}}function loadAddress(){var e=getLocalSession("localAddressSession");$(".content-block2").html();null==e||void 0==e||""==e?queryDefaultAddressOrSetLocalAddress():setAddressInfo(e)}function setAddressInfo(e){var o=JSON.parse(e);if(0==o.length)$(".content-block2").html(nullAddressHtml(l));else{var s=o.province||"",t=(o.city||"",o.country||""),i=s+o.city+t;i+=o.address;var a=o.addressName,n=o.phoneNo,r=n.replace(n.substr(3,7),"****"),d=o.addressId,l='<div addressId = "'+d+'">';l+='<span id="addressName">'+a+'</span> <span class="phone" id="addressPhoneNo">'+r+"</span>",l+='<p><span id="moren">默认</span> <span class="attr phone" id="addressDetail">'+i+"</span></p>",l+="</div>",l+='<div> <img class="img" src="../img/icoJiantou@2x.png" alt=""></div>',$(".content-block2").append(l)}}function queryDefaultAddressOrSetLocalAddress(){var e=getLocalSession("custId")||"",o={};o.interId="toc.getCustDefaultAddress",o.channel="C",o.custId=e,xhq.__runXHQ(o,function(e){if("0"==e.status)if(e.body){var o={addressId:e.body.id,addressName:e.body.name,phoneNo:e.body.phoneNo,province:e.body.province,city:e.body.city,country:e.body.country,address:e.body.address,defaultFlag:e.body.defaultFlag};setLocalSession("localAddressSession",JSON.stringify(o)),setAddressInfo(JSON.stringify(o))}else $(".content-block2").append(nullAddressHtml());else $.alert(e.message)})}function nullAddressHtml(){var e='<div style="position:absolute;top:34pt;font-size:0.85rem;width:90vw;">';return e+='<img style="width:16pt;height:16pt;vertical-align:middle;position: relative;top: -1pt;" src="../img/oval@2x.png" alt="">',e+='<span style="padding-left:5pt;color:rgb(0,0,0)">你还未添加收货地址</span> <span style="position:absolute;top:0pt;right:20pt;color:rgb(222, 63, 55)">去添加</span>',e+='</div> <div> <img class="img" src="../img/icoJiantou@2x.png" alt=""></div>'}function bindEvent(){$("#goback").click(function(){window.history.go(-1)}),$(".content-block2").click(function(){var e=getLocalSession("localAddressSession");null==e||void 0==e||""==e?xhq.gotoUrl("address_register.html",{type:2,pageType:1}):xhq.gotoUrl("address_list.html",{pageType:1})});$(".list1").each(function(){var e=$(this).find(".list1-wenzi  .price").attr("salePrice"),o=$(this).find(".list1-wenzi  .img").attr("num");originalPrice+=e*o});var e=getLocalSession("channelType");3==e&&($("#originalPrice").removeClass("bargain-price"),$("#fukuanId").text("实付积分:"),$("#realPay").removeClass("fukuan price"),$("#paymentContent").text("确认兑换")),$("#originalPrice").text(function(){return 3==e?parseFloat(originalPrice).toString():(parseFloat(originalPrice)/100).toString()}),$("#avoidExpressFee1").text(function(){return(parseFloat(avoidExpressFee)/100).toString()}),$("#expressFee1").text(function(){return parseFloat(originalPrice)>=parseFloat(avoidExpressFee)?(0).toString():(parseFloat(expressFee)/100).toString()}),$("#realPay").text(function(){return 3==e?parseFloat(originalPrice)>=parseFloat(avoidExpressFee)?parseFloat(originalPrice).toString():(originalPrice+parseFloat(expressFee)).toString():parseFloat(originalPrice)>=parseFloat(avoidExpressFee)?(parseFloat(originalPrice)/100).toString():((originalPrice+parseFloat(expressFee))/100).toString()}),$(".content-block .content-block1 img").click(function(){$(".content-block1").hide()}),$(".xia").click(function(){var e=getLocalSession("sourceId")||"",o=xhq.getQuery("fromCustId")||"";""!=e&&0!=e||(e=o),$(this).addClass("none"),openIndicator();var s=getLocalSession("openid")||"",t=getLocalSession("custId")||"",i=$(".content-block2").find("div").eq(0).attr("addressId")||"",a=getLocalSession("sourceType")||"",n=getLocalSession("channelType")||"",r=getLocalSession("groupId")||"";if(""==s||""==t)return hideIndicator(),$.toast("未获取到用户信息，无法访问"),void xhq.gotoErrorPage();if(""==n)return hideIndicator(),$(this).removeClass("none"),void $.toast("订单渠道类型不能为空，无法访问");if("4"==n&&""==r)return hideIndicator(),$(this).removeClass("none"),void $.toast("参团信息不能为空");if(""==i||void 0==i||null==i)return hideIndicator(),$(this).removeClass("none"),void $.toast("用户地址信息不能为空");var d=JSON.parse(getLocalSession("localOrderSession")),l={};l.interId="toc.createOrder",l.channel="C",l.custId=t,l.addressId=i,l.remark=$("#remark").val(),l.expressFee=parseFloat(100*$("#expressFee1").text()).toFixed(0),l.totalNum="",3==n?l.realPay=parseFloat($("#realPay").text()).toFixed(0):l.realPay=parseFloat(100*$("#realPay").text()).toFixed(0),1==$("#deductionCashCheckBox").val()?(l.deductionStatus=1,l.deductionPrice=$("#deductionCashId").attr("deductionCash")):(l.deductionStatus=0,l.deductionPrice=0),l.shippingModel=$("input[name='shippingModel']:checked").val(),l.details=d,l.sourceId=e,l.sourceType=a,l.channelType=n,l.groupId=r;var c=$(this),p=l;xhq.__runXHQ(p,function(e){if(0==e.status){var o=getLocalSession("mallType")||"",s=e.body.orderNo,t=e.body.groupId||"",i=e.body.channelType,a=e.body.deductionStatus||"",n=e.body.payMoney||"";if("1"==a&&"0"==n){if(setLocalSession("localOrderSession",""),"gwcgm"==o){var r=getLocalSession("unCheckShoppingCartLocalSession");null==r&&void 0==r&&""==r||(r=""),setLocalSession("shoppingCartLocalSession",r)}xhq.gotoUrl("../html/paysuccess.html",{orderNo:s,channelType:i,groupId:t})}else if(3!=i){var d={};d.appId=e.body.weiData.appId,d.nonceStr=e.body.weiData.nonceStr.toString(),d["package"]=e.body.weiData.packageInfo,d.paySign=e.body.weiData.paySign,d.timeStamp=e.body.weiData.timeStamp+"",xhq.wxPay(d,function(e){if(hideIndicator(),setLocalSession("localOrderSession",""),"gwcgm"==o){var a=getLocalSession("unCheckShoppingCartLocalSession");null==a&&void 0==a&&""==a||(a=""),setLocalSession("shoppingCartLocalSession",a)}"4"==i?xhq.gotoUrl("../html/tour_successful.html",{orderNo:s,channelType:i,groupId:t}):xhq.gotoUrl("../html/paysuccess.html",{orderNo:s,channelType:i,groupId:t})},function(){hideIndicator(),$.toast("支付失败"),xhq.gotoUrl("../html/order_list.html")})}else xhq.gotoUrl("../html/paysuccess.html",{orderNo:s,channelType:i})}else hideIndicator(),$.alert(e.message),c.removeClass("none")})})}var avoidExpressFee=0,expressFee=0,deliverSureDay=7,deductionPrice=0,originalPrice=0,userType;$(document).ready(function(){var e=document.referrer;e&&(e.indexOf("goods_")>0||e.indexOf("shopping")>0)&&(setLocalSession("sourceId",""),setLocalSession("groupId",""),setLocalSession("sourceType",""),setLocalSession("channelType",""),setLocalSession("mallType",""));var o=xhq.getQuery("sourceId"),s=xhq.getQuery("sourceType"),t=xhq.getQuery("channelType"),i=xhq.getQuery("groupId")||"",a=xhq.getQuery("mallType")||"";null==t||""==t||void 0==t?(t=getLocalSession("channelType"),null!=t&&""!=t&&void 0!=t||(t=1,s=3,setLocalSession("sourceId",""),setLocalSession("groupId",""),setLocalSession("sourceType",s),setLocalSession("channelType",t),setLocalSession("mallType",a))):(o||(o=""),s||(s="3"),t||(t="1"),i||(i=""),setLocalSession("sourceId",o),setLocalSession("sourceType",s),setLocalSession("channelType",t),setLocalSession("groupId",i),setLocalSession("mallType",a));var n=getLocalSession("openid")||"",r=getLocalSession("custId")||"";if(userType=getLocalSession("userType")||"",""==n||""==r)return $.toast("未获取到用户信息，无法访问"),void xhq.gotoErrorPage();openIndicator();var d={interId:"toc.getAvoidExpressFee",channel:"C"};xhq.__runXHQ(d,function(e){0==e.status?(avoidExpressFee=e.body.avoidExpressFee,expressFee=e.body.expressFee,deliverSureDay=e.body.cancelDelday,0==avoidExpressFee&&$("#adtOrderTitle").html(deliverSureDay+"天无忧退货  全场包邮"),loadAddress(),loadOrder(),loadDeduction(),hideIndicator(),bindEvent()):$.toast(e.message)})});